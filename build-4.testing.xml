<?xml version="1.0" encoding="UTF-8"?>

<!--
  ~ Copyright (c) 2007-2015 AREasy Runtime
  ~
  ~ This library, AREasy Runtime and API for BMC Remedy AR System, is free software ("Licensed Software");
  ~ you can redistribute it and/or modify it under the terms of the GNU Lesser General Public
  ~ License as published by the Free Software Foundation; either version 2.1 of the License,
  ~ or (at your option) any later version.
  ~
  ~ This library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  ~ including but not limited to, the implied warranty of MERCHANTABILITY, NONINFRINGEMENT,
  ~ or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.
  -->

<project name="4.Tests" basedir="." >

    <!-- Import Ant object file -->
    <import file="build-1.base.xml"/>

    <!-- Testing environment properties -->
    <property name="areasy.home" value="${env.AREASY_HOME}"/>

    <!-- Test properties -->
    <property file="${tests.src}/definitions.properties"/>
    <property name="param1" value="demo"/>


    <!--input message="Select the test name: " validargs="aar.devpackage" addproperty="test.name"/>
    <input message="Specify the test index: " addproperty="test.index"/-->

    <!-- Define operating system variables -->
    <condition property="isUnix">
        <or>
            <os name="Linux"/>
            <os name="Unix"/>
        </or>
    </condition>
    <condition property="isWindows">
        <or>
            <os name="Windows 7"/>
            <os name="Windows 8"/>
        </or>
    </condition>


    <!-- Take test name and index based on input arguments and run it -->
    <target name="1.Exec" description="Prompt to select a test and run it">
        <property name="in.name" value="${arg0}"/>
        <property name="in.index" value="${arg1}"/>

        <antcall target="1.1.Exec.Caller" inheritrefs="true" inheritall="true"/>
    </target>


    <target name="1.1.Exec.Caller">
        <macrodef name="testcase-name">
            <attribute name="var-name" default=""/>
            <element name="runner-name" optional="yes"/>
            <sequential>
                <property name="test.name" value="${@{var-name}}"/>
                <runner-name/>
            </sequential>
        </macrodef>
        <macrodef name="testcase-details">
            <attribute name="var-details" default=""/>
            <element name="runner-details" optional="yes"/>
            <sequential>
                <property name="test.details" value="${@{var-details}}"/>
                <runner-details/>
            </sequential>
        </macrodef>
        <macrodef name="testcase-action">
            <attribute name="var-action" default=""/>
            <element name="runner-action" optional="yes"/>
            <sequential>
                <property name="test.action" value="${@{var-action}}"/>
                <runner-action/>
            </sequential>
        </macrodef>
        <macrodef name="testcase-arguments">
            <attribute name="var-arguments" default=""/>
            <element name="runner-arguments" optional="yes"/>
            <sequential>
                <property name="test.arguments" value="${@{var-arguments}}"/>
                <runner-arguments/>
            </sequential>
        </macrodef>

        <testcase-name var-name="${in.name}.${in.index}.name">
            <runner-name/>
        </testcase-name>
        <testcase-details var-details="${in.name}.${in.index}.details">
            <runner-details/>
        </testcase-details>
        <testcase-action var-action="${in.name}.${in.index}.action">
            <runner-action/>
        </testcase-action>
        <testcase-arguments var-arguments="${in.name}.${in.index}.arguments">
            <runner-arguments/>
        </testcase-arguments>

        <delete includeemptydirs="true" quiet="true">
            <fileset dir="${tests.out}" includes="**/*"/>
        </delete>

        <mkdir dir="${tests.out}"/>

        <echo message="${test.name}: ${test.details}"/>

        <antcall target="1.2.Exec.onWin" inheritrefs="true" inheritall="true"/>
        <antcall target="1.3.Exec.onUnix" inheritrefs="true" inheritall="true"/>
    </target>


    <target name="1.2.Exec.onWin" if="isWindows">
        <!-- Run AREasy -->
        <exec executable="${areasy.home}/bin/areasy.bat">
            <arg value="-${test.runtime.mode}"/>
            <arg value="-arserver"/>
            <arg value="${test.arsystem.server}"/>
            <arg value="-arport"/>
            <arg value="${test.arsystem.port}"/>
            <arg value="-aruser"/>
            <arg value="${test.arsystem.user}"/>
            <arg value="-arpassword"/>
            <arg value="${test.arsystem.passwd}"/>
            <arg value="-loglevel"/>
            <arg value="${test.runtime.loglevel}"/>
            <arg value="-action"/>
            <arg value="${test.action}"/>
            <arg line="${test.arguments}"/>
        </exec>
    </target>


    <target name="1.3.Exec.onUnix" if="isUnix">
        <!-- Run AREasy -->
        <exec executable="${areasy.home}/bin/areasy.sh">
             <arg value="-${test.runtime.mode}"/>
            <arg value="-arserver"/>
            <arg value="${test.arsystem.server}"/>
            <arg value="-arport"/>
            <arg value="${test.arsystem.port}"/>
            <arg value="-aruser"/>
            <arg value="${test.arsystem.user}"/>
            <arg value="-arpassword"/>
            <arg value="${test.arsystem.passwd}"/>
            <arg value="-loglevel"/>
            <arg value="${test.runtime.loglevel}"/>
            <arg value="-action"/>
            <arg value="${test.action}"/>
            <arg line="${test.arguments}"/>
        </exec>
    </target>


    <!-- Ask for test name and index and run it -->
    <target name="2.AskRun" description="Prompt to select a test and run it">
        <input message="Specify the test name: " addproperty="in.name"/>
        <input message="Specify the test index: " addproperty="in.index"/>

        <antcall target="1.1.Exec.Caller" inheritrefs="true" inheritall="true"/>
    </target>

</project>